!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).createPuzzle={})}(this,(function(t){"use strict";var e=Object.prototype.toString,n=Math.min,o=Math.max,r=Math.random,i=Math.floor,a=Math.ceil,c="[object Symbol]",s="[object Blob]";function u(t){return"function"==typeof t||function(t){return null!==t&&"object"==typeof t}(t)}function h(t){return e.call(t)}var p=/^0b[01]+$/i,f=/^0o[0-7]+$/i,l=/^[-+]0x[0-9a-f]+$/i;function d(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||h(t)===c}(t))return NaN;if(u(t)&&(t=Number(t)),"string"!=typeof t)return 0===t?t:+t;t=t.trim();var e=p.test(t);return e||f.test(t)?parseInt(t.slice(2),e?2:8):l.test(t)?NaN:+t}var y=17976931348623157e292;function v(t){return t?(t=d(t))===1/0||t===-1/0?(t<0?-1:1)*y:t==t?t:0:0===t?t:0}function m(t,e){void 0===t&&(t=0),void 0===e&&(e=1),t=v(t),e=v(e);var c=a(n(t,e)||0),s=i(o(t,e)||0);if(c>s){var u=c;c=s,s=u}return i(c+r()*(s-c+1))}var g="undefined"!=typeof Blob;function b(t){return!!(g&&t instanceof Blob)||h(t)===s}var w=0,P="_"+r().toString(36).substring(2,4);function O(t){return void 0===t&&(t=P),""+t+ ++w}var x,_="undefined"!=typeof URL,k=Object.keys,I=_?URL.createObjectURL:(x="",function(){return x}),j=_?URL.revokeObjectURL:function(){},L=function(t,e){return L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},L(t,e)};var T=function(){return T=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},T.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var C=[200,304];function S(t,e){return new Promise((function(n,o){var r,i,a,c,s,u,h,p,f,l,d,y,v,m,g,w,P,O,x,_,I,j,L,S,R,E;b(t)?n(t):(r=t,i=T({responseType:"blob"},e),a=i||{},c=a.method,s=void 0===c?"get":c,u=a.data,h=void 0===u?null:u,p=a.timeout,f=a.headers,l=a.withCredentials,d=void 0!==l&&l,y=a.async,v=void 0===y||y,m=a.user,g=void 0===m?null:m,w=a.password,P=void 0===w?null:w,O=a.responseType,x=a.onReadyStateChange,_=a.onLoadStart,I=a.onProgress,j=a.onAbort,L=a.onTimeout,S=a.onError,R=a.onLoad,E=a.onLoadEnd,new Promise((function(t,e){var n=new XMLHttpRequest;n.open(s.toLowerCase(),r,v,g,P),x&&(n.onreadystatechange=x),"number"==typeof p&&p>0&&(n.timeout=p),n.withCredentials=d,O&&(n.responseType=O),"object"==typeof f&&k(f).map((function(t){n.setRequestHeader(t,f[t])}));var o,i=function(t){return function(o){e(o),null==t||t.call(n,o)}},a={loadstart:_,progress:I,abort:i(j),timeout:i(L),error:i(S),load:(o=R,function(e){t(e),null==o||o.call(n,e)}),loadend:E};k(a).map((function(t){var e=a[t];e&&n.addEventListener(t,e)})),n.send(h)}))).then((function(e){var r=e.target.status;if(-1!==C.indexOf(r))n(e.target.response);else{var i=new Error("The file does not support get requests, responseStatus ".concat(r,", '").concat(t,"'."));console.error(i),o(i)}})).catch((function(t){console.error(new Error("Failed to request file. ".concat(t))),o(t)}))}))}function R(t,e){return S(t,e).then((function(t){return function(t){return new Promise((function(e,n){var o=b(t),r=o?I(t):t,i=new Image;o||(i.crossOrigin="anonymous"),i.onload=function(){e(i)},i.onerror=function(e){o&&j(r),console.error("[loadImage] The image load failed, '".concat(t,"'.")),n(e)},i.src=r}))}(t).then((function(e){return{blob:t,image:e}}))}))}var E=function(){function t(){this.handlers={}}return t.prototype.eventNames=function(){var t,e=(null===(t=Object.getOwnPropertySymbols)||void 0===t?void 0:t.call(Object,this.handlers))||[];return Object.keys(this.handlers).concat(e)},t.prototype.rawListeners=function(t){var e=this.handlers[t];return e?e.map((function(t){return t.raw})):[]},t.prototype.listeners=function(t){var e=this.handlers[t];return e?e.map((function(t){return t.wrap})):[]},t.prototype.hasListener=function(t,e){return this.rawListeners(t).some((function(t){return t===e}))},t.prototype._on=function(t,e,n,o,r){void 0===o&&(o=null),void 0===r&&(r=1);var i={raw:e,wrap:n,context:o};if(this.handlers[t]){var a=1===r?"push":"unshift";this.handlers[t][a](i)}else this.handlers[t]=[i];return this},t.prototype.prependListener=function(t,e,n){return this._on(t,e,e,n,0)},t.prototype.on=function(t,e,n){return this._on(t,e,e,n)},t.prototype._wrapOnce=function(t,e,n){var o=this;void 0===n&&(n=null);var r=function(){for(var i=[],a=0;a<arguments.length;a++)i[a]=arguments[a];e.apply(n,i),o.off(t,r)};return r},t.prototype.once=function(t,e,n){var o=this._wrapOnce(t,e,n);return this._on(t,e,o,n)},t.prototype.prependOnceListener=function(t,e,n){var o=this._wrapOnce(t,e,n);return this._on(t,e,o,n,0)},t.prototype.off=function(t,e){var n=this.handlers[t];if(n)if(e){var o=n.findIndex((function(t){return t.wrap===e||t.raw===e}));-1!==o&&n.splice(o,1)}else delete this.handlers[t];return this},t.prototype.offAll=function(){return this.handlers={},this},t.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var o=this.handlers[t];return!!(o&&o.length>0)&&(o.forEach((function(t){t.wrap.apply(t.context,e)})),!0)},t}();var N=1;function U(){return"".concat(Math.random().toString(16).substring(2,8),"_").concat(N++)}var V,M={},z=function(){function t(t){void 0===t&&(t="default"),this.scope=t,M[this.scope]||(M[this.scope]={}),this.data=M[this.scope]}return t.prototype.getItem=function(t){return t in this.data?this.data[t]:null},t.prototype.setItem=function(t,e){this.data[t]=e},t.prototype.removeItem=function(t){delete this.data[t]},t.prototype.clear=function(){M[this.scope]={},this.data=M[this.scope]},t}(),A=function(){function t(t,e){void 0===e&&(e={});var n=!!t&&function(t){try{var e="object"==typeof t&&null!==t&&!!t.setItem&&!!t.getItem&&!!t.removeItem;if(e){var n=U();if(t.setItem(n,"1"),"1"!==t.getItem(n))return!1;t.removeItem(n)}return e}catch(e){return console.error("[cache2] ".concat(t," is not supported. The default memory cache will be used.")),!1}}(t);this.options=T({needParsed:n},e),this.storage=n?t:new z(this.options.memoryScope)}return t.prototype.get=function(t){var e=this.storage.getItem(t);return this.options.needParsed?function(t,e){try{return JSON.parse(t,e)}catch(e){return t}}(e,this.options.reviver):e},t.prototype.set=function(t,e){this.storage.setItem(t,this.options.needParsed?function(t,e){return JSON.stringify(t,e)}(e,this.options.replacer):e)},t.prototype.del=function(t){this.storage.removeItem(t)},t.prototype.clear=function(){"function"==typeof this.storage.clear&&this.storage.clear()},t}(),W=function(t){function e(e,n){var o,r=t.call(this)||this,i="default";return"string"==typeof e?i=e:"object"==typeof e&&(o=e),o||"object"!=typeof n||(o=n),r.options=T({max:-1,stdTTL:0,maxStrategy:"limited",checkperiod:0,prefix:"cache2_"},o),r.storage=new A(r.options.storage,T({memoryScope:i},o)),r.cacheKey=(r.options.prefix||"")+(i||"")||U(),r.startCheckperiod(),r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}L(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e.prototype._check=function(t,e){var n=!0;return 0!==e.t&&e.t<Date.now()&&(n=!1,this.del(t),this.emit("expired",t,e.v)),n},e.prototype._wrap=function(t,e){var n=Date.now(),o="number"==typeof e?e:this.options.stdTTL;return{v:t,t:o>0?n+o:0,n:n}},e.prototype._isLimited=function(t){return this.options.max>-1&&t>=this.options.max},e.prototype._getReplaceKey=function(t,e){var n=t[0];return t.forEach((function(t){(e[t].t<e[n].t||e[t].t===e[n].t&&e[t].n<e[n].n)&&(n=t)})),n},Object.defineProperty(e.prototype,"cacheValues",{get:function(){return this.storage.get(this.cacheKey)||{}},enumerable:!1,configurable:!0}),e.prototype.setCacheValues=function(t){this.storage.set(this.cacheKey,t)},e.prototype.get=function(t){var e=this.cacheValues[t];if(e&&this._check(t,e))return e.v},e.prototype.mget=function(t){var e=this,n={};if(!Array.isArray(t))return n;var o=this.cacheValues;return t.forEach((function(t){var r=o[t];r&&e._check(t,r)&&(n[t]=r.v)})),n},e.prototype.getAll=function(){var t=Object.keys(this.cacheValues);return this.mget(t)},e.prototype.set=function(t,e,n){if(0===this.options.max)return!1;var o=this.cacheValues,r=Object.keys(o);if(!o[t]&&this._isLimited(r.length)){var i=this.keys();if(this._isLimited(i.length)){if("replaced"!==this.options.maxStrategy)return!1;var a=this._getReplaceKey(i,o);this.del(a)}}return o[t]=this._wrap(e,n),this.setCacheValues(o),this.emit("set",t,o[t].v),!0},e.prototype.mset=function(t){var e=this,n=!0;return t.forEach((function(t){var o=e.set(t.key,t.value,t.ttl);n&&!o&&(n=!1)})),n},e.prototype.del=function(t){var e=this,n=this.cacheValues,o=0;return(Array.isArray(t)?t:[t]).forEach((function(t){if(n[t]){o++;var r=n[t];delete n[t],e.emit("del",t,r.v)}})),o>0&&this.setCacheValues(n),o},e.prototype.clear=function(){this.storage.del(this.cacheKey)},e.prototype.keys=function(){var t=this,e=this.cacheValues;return Object.keys(e).filter((function(n){return t._check(n,e[n])}))},e.prototype.has=function(t){var e=this.cacheValues[t];return!(!e||!this._check(t,e))},e.prototype.take=function(t){var e,n=this.cacheValues[t];return n&&this._check(t,n)&&(e=n.v,this.del(t)),e},e.prototype.ttl=function(t,e){var n=this.cacheValues,o=n[t];return!(!o||!this._check(t,o))&&(n[t]=this._wrap(o.v,e),!0)},e.prototype.getTtl=function(t){var e=this.cacheValues,n=e[t];if(n&&this._check(t,n))return e[t].t},e.prototype.getLastModified=function(t){var e=this.cacheValues,n=e[t];if(n&&this._check(t,n))return e[t].n},e.prototype.startCheckperiod=function(){var t=this;this.keys(),this.options.checkperiod>0&&(clearTimeout(this._checkTimeout),this._checkTimeout=setTimeout((function(){t.startCheckperiod()}),this.options.checkperiod))},e.prototype.stopCheckperiod=function(){clearTimeout(this._checkTimeout)},e}(E),q=function(){function t(t){this.promiseCache={},this.cache=new W(O("uh_async_memo"),t)}return t.prototype.run=function(t,e,n){var o=this;if(!e||!function(t){return"string"==typeof t||"[object String]"===h(t)}(e))return t();var r=T({persisted:!0},n);if(r.persisted){var i=this.cache.get(e);if(i)return Promise.resolve(i)}return this.promiseCache[e]||(this.promiseCache[e]=t().then((function(t){return delete o.promiseCache[e],o.cache.set(e,t,r.ttl),t})).catch((function(t){return delete o.promiseCache[e],Promise.reject(t)}))),this.promiseCache[e]},t}(),D=q,K=Math.PI;t.Point=void 0,(V=t.Point||(t.Point={}))[V.None=0]="None",V[V.Outer=1]="Outer",V[V.Inner=2]="Inner";var B=[t.Point.None,t.Point.Outer,t.Point.Inner];function H(t){return t[m(0,t.length-1)]}function $(e){var n={top:H(B),right:H(B),bottom:H(B),left:H(B)},o=Object.keys(n),r=["top","bottom"],i=["left","right"];if(n.top===t.Point.Outer&&n.bottom===t.Point.Outer?n[H(r)]=t.Point.Inner:n.top!==t.Point.Outer&&n.bottom!==t.Point.Outer&&(n[H(r)]=t.Point.Outer),n.left===t.Point.Outer&&n.right===t.Point.Outer?n[H(i)]=t.Point.Inner:n.left!==t.Point.Outer&&n.right!==t.Point.Outer&&(n[H(i)]=t.Point.Outer),e){var a=[],c=[];o.forEach((function(e){n[e]===t.Point.Inner?a.push(e):n[e]===t.Point.None&&c.push(e)})),2===e?a.forEach((function(e){return n[e]=t.Point.None})):3===e?0===a.length?n[H(c)]=t.Point.Inner:2===a.length&&(n[H(a)]=t.Point.None):4==e&&c.forEach((function(e){return n[e]=t.Point.Inner}))}return n}function J(e,n){void 0===n&&(n={});var o=n.x,r=void 0===o?0:o,i=n.y,a=void 0===i?0:i,c=n.w,s=void 0===c?60:c,u=n.h,h=void 0===u?60:u,p=n.needClosePath,f=void 0===p||p,l=n.points,d=n.margin,y=void 0===d?0:d;y=y<=0?0:y,"number"!=typeof l&&l||(l=$(l));var v=.15*(Math.min(s,h)-2*y),m=Math.hypot(v,v)/2,g=v+m,b={x:r+y,y:a+y,w:s-g-2*y,h:h-g-2*y},w=b.w/2,P=b.h/2;l.left===t.Point.Outer&&(b.x+=g),l.top===t.Point.Outer&&(b.y+=g),e.beginPath(),e.lineWidth=2,e.moveTo(b.x,b.y),l.top!==t.Point.None&&(e.lineTo(b.x+w-m,b.y),l.top===t.Point.Inner?e.arc(b.x+w,b.y+m,v,1.25*K,1.75*K,!0):e.arc(b.x+w,b.y-m,v,.75*K,.25*K)),e.lineTo(b.x+b.w,b.y),l.right!==t.Point.None&&(e.lineTo(b.x+b.w,b.y+P-m),l.right===t.Point.Inner?e.arc(b.x+b.w-m,b.y+P,v,1.75*K,.25*K,!0):e.arc(b.x+b.w+m,b.y+P,v,1.25*K,.75*K)),e.lineTo(b.x+b.w,b.y+b.h),l.bottom!==t.Point.None&&(e.lineTo(b.x+w+m,b.y+b.h),l.bottom===t.Point.Inner?e.arc(b.x+w,b.y+b.h-m,v,.25*K,.75*K,!0):e.arc(b.x+w,b.y+b.h+m,v,1.75*K,1.25*K)),e.lineTo(b.x,b.y+b.h),l.left!==t.Point.None&&(e.lineTo(b.x,b.y+P+m),l.left===t.Point.Inner?e.arc(b.x+m,b.y+P,v,.75*K,1.25*K,!0):e.arc(b.x-m,b.y+P,v,.25*K,1.75*K)),e.lineTo(b.x,b.y),e.stroke(),f&&e.closePath()}function F(t,e,n,o){return new Promise((function(r){e?t.toBlob((function(e){r(e?URL.createObjectURL(e):t.toDataURL(n,o))}),n,o):r(t.toDataURL(n,o))}))}var X=new D({max:5,maxStrategy:"replaced"});X.cache.on("del",(function(t,e){try{e.image.src&&URL.revokeObjectURL(e.image.src)}catch(t){}}));var G=new WeakMap,Q="image/jpeg",Y="image/png",Z=[];function tt(t,e){void 0===e&&(e={});var n=e.borderWidth,o=void 0===n?2:n,r=e.borderColor,i=void 0===r?"rgba(255,255,255,0.7)":r,a=e.fillColor,c=void 0===a?"rgba(255,255,255,0.7)":a,s=e.points,h=e.width,p=void 0===h?60:h,f=e.height,l=void 0===f?60:f,d=e.x,y=e.y,v=e.margin,g=void 0===v?2:v,b=e.equalHeight,w=void 0===b||b,P=e.imageWidth,x=e.imageHeight,_=e.bgWidth,k=e.bgHeight,I=e.bgOffset,j=void 0===I?[0,0]:I,L=e.bgImageType,T=void 0===L?Q:L,C=e.quality,S=void 0===C?.8:C,E=e.format,N=void 0===E?"dataURL":E,U=e.cacheImage,V=void 0===U||U,M=e.autoRevokePreviousBlobUrl,z=void 0===M||M,A=e.ajaxOptions;return new Promise((function(e,n){var r,a=document.createElement("canvas"),h=document.createElement("canvas"),f=a.getContext("2d"),v=h.getContext("2d"),b=V?u(r=t)?(G.get(r)||G.set(r,O("cp")),G.get(r)):String(r):void 0;X.run((function(){return R(t,A)}),b).then((function(t){var r=t.image;P&&(r.width=P),x&&(r.height=x);var u="number"==typeof _&&_>0?_>p?_:p:r.width,b="number"==typeof k&&k>0?k>l?k:l:r.height;a.width=u,a.height=b;var O=u-p,I=b-l,L=void 0===d?m(p,O):d||0,C=void 0===y?m(0,I):y||0;L<0?L=0:L>O&&(L=O),C<0?C=0:C>I&&(C=I);var R="number"!=typeof s&&s?s:$(s),E="function"==typeof j?j(r.width,r.height):j;f.strokeStyle=i,f.lineWidth=o,f.fillStyle=c,J(f,{x:L,y:C,w:p,h:l,points:R,margin:g}),f.fillStyle=c,f.fill(),f.globalCompositeOperation="destination-over",f.drawImage(r,E[0],E[1],r.width,r.height),h.width=u,h.height=b,v.strokeStyle=i,v.lineWidth=o,J(v,{x:L,y:C,w:p,h:l,points:R,margin:g}),v.globalCompositeOperation="destination-over",v.clip(),v.drawImage(r,E[0],E[1],r.width,r.height);var U=v.getImageData(L,C,p,l);v.clearRect(0,0,u,b),h.width=p,h.height=w?b:l,v.putImageData(U,0,w?C:0);var V="blob"===N,M=F(h,V,Y,S),A=F(a,V,T,S);Promise.all([M,A]).then((function(t){var n=t[0],o=t[1];z&&(Z.length&&(Z.forEach((function(t){URL.revokeObjectURL(t)})),Z.length=0),V&&Z.push(o,n)),e({puzzleUrl:n,bgUrl:o,x:L,y:w?0:C})})).catch(n)})).catch(n)}))}t.clearCache=function(t){t?X.cache.del(t):X.cache.clear()},t.createPuzzle=tt,t.default=tt,t.drawPuzzle=J,t.getRandomPoints=$,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=createPuzzle.min.js.map
